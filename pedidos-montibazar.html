<script>
    const WEBHOOK_URL = 'https://hook.us2.make.com/7qyang1uvx43d3n5c78hdxo39ew1b7n8';
    
    const productos = [
        // HOGAR
        {n: "SET CUCHILLOS DE COCINA 9 PIEZAS", p: 99, c: "hogar"},
        {n: "PLANCHA ELECTRICA DE ROPA", p: 110, c: "hogar"},
        {n: "SANDWICHERA 800W", p: 98, c: "hogar"},
        {n: "BATIDORA DE MANO ELECTRICA 600W", p: 96, c: "hogar"},
        {n: "CAFETERA ELECTRICA 625mL", p: 126, c: "hogar"},
        {n: "LICUADORA STARLUX 2 EN 1 1.5L", p: 126, c: "hogar"},
        {n: "HERVIDOR ELECTRICO 2.5L", p: 72, c: "hogar"},
        {n: "MAQUINA TOSTADORA 650W", p: 110, c: "hogar"},
        {n: "MINI BATIDORA ELECTRICA 260W", p: 67, c: "hogar"},
        {n: "PLANCHA A VAPOR ELECTRICO", p: 80, c: "hogar"},
        {n: "PLANCHA ALIZADORA DE CABELLO", p: 72, c: "hogar"},
        {n: "SECADORA DE CABELLO DORADA", p: 72, c: "hogar"},
        {n: "SET DE UTENSILIOS", p: 100, c: "hogar"},
        {n: "JUEGO DE CUCHILLOS 6 PIEZAS", p: 65.5, c: "hogar"},
        {n: "ORGANIZADOR ESTANTE DE BAÑO", p: 80, c: "hogar"},
        {n: "ESTANTE ORGANIZADOR DE COCINA 3 NIVELES", p: 58, c: "hogar"},
        {n: "CARRITO ORGANIZADOR 3 NIVELES CON RUEDAS", p: 95, c: "hogar"},
        {n: "TERMO CON JUEGO DE DOS TAZAS", p: 57.5, c: "hogar"},
        {n: "TERMO DE ACERO INOXIDABLE", p: 50, c: "hogar"},
        
        // PARLANTES
        {n: "PARLANTE G BT 2301", p: 57, c: "parlantes"},
        {n: "PARLANTE G CON RELOJ 6en1", p: 72, c: "parlantes"},
        {n: "MINI PARLANTE MAGNETICO G200", p: 63, c: "parlantes"},
        {n: "MINI PARLANTE BLUETOOTH WIND 3S", p: 63, c: "parlantes"},
        {n: "MINI PARLANTE CILINDRICA LUZ LED", p: 48, c: "parlantes"},
        {n: "MINI PARLANTE CON LINTERNA Y PANEL SOLAR", p: 57, c: "parlantes"},
        {n: "MINI PARLANTE CON LUZ LED", p: 57, c: "parlantes"},
        {n: "MINI PARLANTE GRECTINE", p: 49.5, c: "parlantes"},
        {n: "PARLANTE 4 PULGADAS CON LUZ RGB", p: 63, c: "parlantes"},
        {n: "HIELERA PARLANTE BLUETOOTH CON LUZ RGB", p: 57, c: "parlantes"},
        
        // LUMINARIAS
        {n: "FOCO LAMPARA SOLAR RECARGABLE 30W", p: 57, c: "luminarias"},
        {n: "FOCO LED A COLORES MUSICAL", p: 72, c: "luminarias"},
        {n: "LAMPARA MATA MOSQUITOS 2 EN 1", p: 65, c: "luminarias"},
        {n: "LUCES GIRNALDAS CON PANEL SOLAR", p: 118, c: "luminarias"},
        {n: "LUZ LED SOLAR CON SENSOR DE MOVIMIENTO", p: 41, c: "luminarias"},
        
        // JUEGOS
        {n: "CONSOLA DE JUEGO CON MANDOS RECARGABLES", p: 220, c: "juegos"},
        {n: "CONSOLA DE JUEGO DE 20000 JUEGOS", p: 124, c: "juegos"},
        {n: "CONSOLA DE JUEGOS 3D CON DOS MANDOS X2", p: 202, c: "juegos"},
        {n: "CONSOLA DE JUEGOS 3D GAMES 5G", p: 247, c: "juegos"},
        
        // NOVEDADES
        {n: "MAQUINA CORTADORA DE CABELLO INALAMBRICA", p: 110, c: "novedades"},
        {n: "MAQUINA CORTADORA DE PELO RECARGABLE", p: 93, c: "novedades"},
        {n: "MAQUINA CORTADO DE PELO DEXBO", p: 109, c: "novedades"},
        {n: "HIDROLAVADORA 48V", p: 124, c: "novedades"},
        {n: "INTERCOMUNICADOR PARA CASCO Q58 MAX", p: 140, c: "novedades"},
        {n: "AUDIFONO BLUETOOTH PARA CASCO Q28", p: 278, c: "novedades"},
        {n: "MORRAL FASHION ANTIROBO", p: 49, c: "novedades"},
        {n: "LENTES DE SOL CON BLUETOOTH", p: 48, c: "novedades"},
        {n: "CARGADOR INALAMBRICO 3 EN 1 CON RELOJ", p: 72, c: "novedades"},
        {n: "PISTOLA DE BURBUJA 32 HOYOS", p: 34, c: "novedades"}
    ];
    
    let cant = {};
    
    function render(filtro = 'todos') {
        const cont = document.getElementById('productsList');
        cont.innerHTML = '';
        
        const productosFiltrados = filtro === 'todos' 
            ? productos 
            : productos.filter(p => p.c === filtro);
        
        productosFiltrados.forEach((prod, i) => {
            const globalIndex = productos.indexOf(prod);
            cant[globalIndex] = cant[globalIndex] || 0;
            
            const div = document.createElement('div');
            div.className = 'product-item';
            div.innerHTML = `
                <div class="product-info">
                    <div class="product-name">${prod.n}</div>
                    <div class="product-price">S/. ${prod.p}</div>
                </div>
                <div class="quantity-control">
                    <button type="button" class="qty-btn" onclick="upd(${globalIndex},-1)">−</button>
                    <input type="number" class="qty-input" id="q${globalIndex}" value="${cant[globalIndex]}" readonly>
                    <button type="button" class="qty-btn" onclick="upd(${globalIndex},1)">+</button>
                </div>
            `;
            cont.appendChild(div);
        });
    }
    
    function upd(i, ch) {
        cant[i] = Math.max(0, (cant[i] || 0) + ch);
        const inp = document.getElementById('q'+i);
        if (inp) inp.value = cant[i];
        calc();
    }
    
    function calc() {
        let tot = 0;
        productos.forEach((p, i) => { tot += p.p * (cant[i] || 0); });
        document.getElementById('totalAmount').textContent = tot.toFixed(0);
    }
    
    document.getElementById('categoria').addEventListener('change', (e) => {
        render(e.target.value);
    });
    
    document.getElementById('orderForm').onsubmit = async (e) => {
        e.preventDefault();
        
        let prods = [];
        let tot = 0;
        productos.forEach((p, i) => {
            if (cant[i] > 0) {
                prods.push(`${cant[i]}x ${p.n} (S/.${(p.p * cant[i]).toFixed(2)})`);
                tot += p.p * cant[i];
            }
        });
        
        if (prods.length === 0) {
            alert('Selecciona al menos un producto');
            return;
        }
        
        const data = {
            cliente: document.getElementById('nombre').value,
            correo: document.getElementById('correo').value,
            telefono: document.getElementById('telefono').value,
            direccion: document.getElementById('direccion').value,
            productos: prods.join(', '),
            total: tot.toFixed(2),
            comentarios: document.getElementById('comentarios').value || ''
        };
        
        try {
            await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            document.getElementById('successMsg').style.display = 'block';
            document.getElementById('orderForm').reset();
            cant = {};
            render();
            setTimeout(() => {
                document.getElementById('successMsg').style.display = 'none';
            }, 5000);
        } catch (err) {
            console.error('Error:', err);
            alert('Pedido enviado. Revisa tu base de datos en Notion.');
        }
    };
    
    render();
</script>
